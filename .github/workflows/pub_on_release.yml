name: Publish on Docker Hub and Deploy

on:
  push:
    branches:
      - master
#  release:
#    types: [published]
#   –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞

jobs:
  run_tests:
    # –ü–µ—Ä–≤—É—é –¥–∂–æ–±—É —Å–º–µ–ª–æ –º–æ–∂–µ–º –∫–æ–ø–∏–ø–∞—Å—Ç–∏—Ç—å –∏–∑ —ç–∫—à–µ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    runs-on: [ ubuntu-latest ]
    steps:
      # –ß–µ–∫–∞—É—Ç–∏–º –∫–æ–¥
      - uses: actions/checkout@master
      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º python –Ω—É–∂–Ω–æ–π –≤–µ—Ä—Å–∏–∏
      - uses: actions/setup-python@v1
        with:
          python-version: '3.10'
      - name: Install requirements
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: pip install -r requirements.txt
      - name: Run tests
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        run: echo "üéâ –¢–£–¢–ê –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –¢–ï–°–¢–´"


  build_and_pub:
    # –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –±—ã–ª–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
    needs: [ run_tests ]
    runs-on: [ ubuntu-latest ]
    env:
      LOGIN: ${{ secrets.DOCKER_LOGIN }}
      NAME: "game_sapper"
    steps:
      - name: Login to docker.io
        # –°–Ω–∞—á–∞–ª–∞ –º—ã –ª–æ–≥–∏–Ω–∏–º—Å—è –≤ docker.io
        run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin
        # –ß–µ–∫–∞—É—Ç–∏–º –∫–æ–¥
      - uses: actions/checkout@master
      - name: Build image
        # –°–æ–±–∏—Ä–∞–µ–º image –∏ –Ω–∞–∑—ã–≤–∞–µ–º –µ–≥–æ —Ç–∞–∫ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ hub.docker —Ç.–µ. login/repository:version
        run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f dockerfile_game_sapper .
      - name: Push image to docker.io
        # –ü—É—à–∏–º –æ–±—Ä–∞–∑ –≤ registry
        run: docker push $LOGIN/$NAME:${GITHUB_REF:11}

#  deploy:
#    # –ï—Å–ª–∏ –º—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤ registry, —Ç–æ –¥–µ–ª–∞–µ–º —Ö—É–∫ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç —Å–µ—Ä–≤–µ—Ä—É
#    # –ü–æ–ø—Ä–æ–±—É–µ–º –≥–æ—Ç–æ–≤—ã–π —ç–∫—à–µ–Ω curl –∏–∑ –º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å–∞
#    needs: [ build_and_pub ]
#    runs-on: [ ubuntu-latest ]
#    steps:
#      - name: Set tag to env
#        run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11})
#      - name: Send webhook for deploy
#        run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"